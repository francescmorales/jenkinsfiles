#!groovy
import hudson.*
import hudson.model.*
import jenkins.*
import jenkins.model.*

node('master'){
	stage('readProperties'){
		def envs = readProperties  file: "${WORKSPACE}/../properties/config.properties"
		echo "envs: ${envs}"
	}
}
node('docker-slave'){
    stage('Clone_Git'){
		git url: "${envs.gitURL}", branch: 'develop'
    }
    stage('Build'){
        sh 'docker build -t test /home/jenkins/workspace/Dockerfiles/docker-file-test'
    }
    stage('Deploy_Artifact'){
		//sh 'docker login -u admin -p password docker-virtual.art.local'
		//sh 'docker push docker-virtual.art.local/basic-image-builder'
		
		// Create the upload spec.
		def uploadSpec = """{
				"files": [
						{
							"pattern": "Dockerfile",
							"target": "dockerfiles",
							"recursive": "false"
						}
					]
				}"""
				
		def buildInfo = Artifactory.newBuildInfo()
		buildInfo.setName "Test/Dockerfile"
		def server = Artifactory.server 'artifactory-local'
		server.upload spec: uploadSpec, buildInfo: buildInfo
		server.publishBuildInfo buildInfo
    }
}